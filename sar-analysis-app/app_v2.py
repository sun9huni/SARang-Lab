# -*- coding: utf-8 -*-
"""app_v2.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1_XNCiOoHkKNs9CSOKoLQ1JwyWr5p2cUB
"""

import streamlit as st
import pandas as pd
from rdkit import Chem
# ë³€ê²½ëœ íŒŒì¼ ì´ë¦„ì— ë§ê²Œ import ê²½ë¡œ ìˆ˜ì •
from utils_v2 import load_data, find_activity_cliffs, generate_hypothesis, draw_molecule, train_qsar_model, get_morgan_fingerprint
import plotly.express as px
import numpy as np

# --- í˜ì´ì§€ ê¸°ë³¸ ì„¤ì • ---
st.set_page_config(
    page_title="AI ê¸°ë°˜ SAR/QSAR ë¶„ì„ ì‹œìŠ¤í…œ v2",
    page_icon="ğŸ’Š",
    layout="wide"
)

# --- ì‚¬ì´ë“œë°” ---
with st.sidebar:
    st.image("https://aigensciences.com/images/logo/aigen_logo_h.png", width=200)
    st.title("ë¶„ì„ ì„¤ì • (v2)")
    st.markdown("---")

    uploaded_file = st.file_uploader("SAR/QSAR ë°ì´í„°(.csv)ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.", type="csv")
    use_sample_data = st.checkbox("ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©", value=True)

    st.markdown("---")

    st.subheader("SAR ë¶„ì„ íŒŒë¼ë¯¸í„°")
    similarity_threshold = st.slider("ìœ ì‚¬ë„ ì„ê³„ê°’ (Tanimoto)", 0.5, 1.0, 0.8, 0.05)
    activity_diff_threshold = st.number_input("í™œì„±ë„ ì°¨ì´ ì„ê³„ê°’ (pKi)", min_value=0.1, value=1.0, step=0.1)

# --- ë©”ì¸ í˜ì´ì§€ ---
st.title("ğŸ’Š AI ê¸°ë°˜ SAR & QSAR ë¶„ì„ ì‹œìŠ¤í…œ (v2)")
st.caption("AIGEN SCIENCES & ëª¨ë‘ì˜ì—°êµ¬ì†Œ PoC")

# ë°ì´í„° ë¡œë“œ
df = None
if use_sample_data:
    df = load_data("data/sample_data.csv")
elif uploaded_file:
    df = load_data(uploaded_file)

if df is not None:
    # íƒ­(Tab) UIë¡œ SARì™€ QSAR ê¸°ëŠ¥ ë¶„ë¦¬
    tab1, tab2 = st.tabs(["SAR ë¶„ì„ (Activity Cliff)", "QSAR ì˜ˆì¸¡ (ì‹ ê·œ ë¶„ì)"])

    # --- SAR ë¶„ì„ íƒ­ ---
    with tab1:
        st.header("SAR ë¶„ì„: ì£¼ìš” í™œì„± ë³€í™” ìš”ì¸")
        st.dataframe(df.head())

        fig = px.histogram(df, x='activity', title='í™œì„±ë„(pKi) ë¶„í¬', labels={'activity': 'pKi ê°’'})
        st.plotly_chart(fig, use_container_width=True)

        if st.button("Activity Cliff ë¶„ì„ ì‹œì‘", type="primary", key='sar_button'):
            with st.spinner("Activity Cliffë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."):
                cliffs = find_activity_cliffs(df, similarity_threshold, activity_diff_threshold)
            st.session_state['cliffs'] = cliffs

        if 'cliffs' in st.session_state:
            cliffs = st.session_state['cliffs']
            if not cliffs:
                st.warning("ì„¤ì •ëœ ì¡°ê±´ì— ë§ëŠ” Activity Cliffë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„ê³„ê°’ì„ ì¡°ì •í•´ë³´ì„¸ìš”.")
            else:
                st.success(f"ì´ {len(cliffs)}ê°œì˜ Activity Cliffë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤. ë¶„ì„í•  ìŒì„ ì„ íƒí•˜ì„¸ìš”.")

                cliff_options = [f"{i+1}. {c['mol_1']['ID']} vs {c['mol_2']['ID']} (Î”pKi: {c['activity_diff']:.2f})" for i, c in enumerate(cliffs)]
                selected_option = st.selectbox("ë¶„ì„í•  Activity Cliff ì„ íƒ:", cliff_options, key='cliff_select')

                selected_index = cliff_options.index(selected_option)
                selected_cliff = cliffs[selected_index]

                st.subheader("SAR ìš”ì•½ ë¦¬í¬íŠ¸")
                col1, col2 = st.columns(2)
                mol1_info, mol2_info = selected_cliff['mol_1'], selected_cliff['mol_2']

                with col1:
                    st.info(f"**í™”í•©ë¬¼ 1: {mol1_info['ID']}**")
                    st.image(draw_molecule(mol1_info['SMILES']), caption=f"pKi: {mol1_info['activity']:.2f}")
                with col2:
                    st.info(f"**í™”í•©ë¬¼ 2: {mol2_info['ID']}**")
                    st.image(draw_molecule(mol2_info['SMILES']), caption=f"pKi: {mol2_info['activity']:.2f}")

                st.metric("Tanimoto ìœ ì‚¬ë„", f"{selected_cliff['similarity']:.3f}")

                with st.spinner("AIê°€ í™”í•™ì  ê°€ì„¤ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤..."):
                    hypothesis = generate_hypothesis(selected_cliff)
                if hypothesis:
                    st.markdown("**AI-Generated Hypothesis:**")
                    st.info(hypothesis)

    # --- QSAR ì˜ˆì¸¡ íƒ­ ---
    with tab2:
        st.header("QSAR ì˜ˆì¸¡: ì‹ ê·œ ë¶„ì í™œì„± ì˜ˆì¸¡")

        # ëª¨ë¸ í›ˆë ¨
        with st.spinner("QSAR ëª¨ë¸ì„ í›ˆë ¨ ì¤‘ì…ë‹ˆë‹¤..."):
            if 'qsar_model' not in st.session_state or use_sample_data or uploaded_file:
                 model, message, r2 = train_qsar_model(df)
                 st.session_state['qsar_model'] = model
                 st.session_state['qsar_message'] = message
                 st.session_state['qsar_r2'] = r2

        st.success(st.session_state['qsar_message'])

        if st.session_state['qsar_model']:
            st.subheader("ì‹ ê·œ í™”í•©ë¬¼ ì •ë³´ ì…ë ¥")
            new_smiles = st.text_input("í™œì„±ì„ ì˜ˆì¸¡í•  ë¶„ìì˜ SMILES ë¬¸ìì—´ì„ ì…ë ¥í•˜ì„¸ìš”:", "c1ccccc1")

            if st.button("í™œì„± ì˜ˆì¸¡", type="primary", key='qsar_button'):
                if new_smiles:
                    mol = Chem.MolFromSmiles(new_smiles)
                    if mol:
                        fp = get_morgan_fingerprint(mol)
                        fp_array = np.array(fp).reshape(1, -1)

                        model = st.session_state['qsar_model']
                        predicted_activity = model.predict(fp_array)[0]

                        st.subheader("ì˜ˆì¸¡ ê²°ê³¼")
                        col1, col2 = st.columns(2)
                        with col1:
                            st.image(draw_molecule(new_smiles), caption="ì…ë ¥ëœ ë¶„ì êµ¬ì¡°")
                        with col2:
                            st.metric(label="ì˜ˆì¸¡ëœ pKi í™œì„±ë„", value=f"{predicted_activity:.3f}")
                            st.progress(min(1.0, predicted_activity / 10.0)) # 10ì„ ìµœëŒ€ í™œì„±ë„ë¡œ ê°€ì •
                            st.caption(f"ì°¸ê³ : ëª¨ë¸ì˜ ì˜ˆì¸¡ ì •í™•ë„(RÂ² Score)ëŠ” ì•½ {st.session_state['qsar_r2']:.3f} ì…ë‹ˆë‹¤.")
                    else:
                        st.error("ìœ íš¨í•˜ì§€ ì•Šì€ SMILES ë¬¸ìì—´ì…ë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.")
else:
    st.info("ë¶„ì„ì„ ì‹œì‘í•˜ë ¤ë©´ ì‚¬ì´ë“œë°”ì—ì„œ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ìƒ˜í”Œ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.")
